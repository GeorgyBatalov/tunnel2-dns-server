# Tunnel2 DNS Server

ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ DNS-ÑĞµÑ€Ğ²ĞµÑ€ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° xtunnel2, Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ğ¹ A Ğ¸ TXT Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ğ´Ğ²ÑƒÑ… Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°Ñ…: legacy (ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹) Ğ¸ new (Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°).

## ĞĞ±Ğ·Ğ¾Ñ€

Tunnel2.DnsServer â€” ÑÑ‚Ğ¾ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ DNS-ÑĞµÑ€Ğ²ĞµÑ€, Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğ¹ Ğ½Ğ° .NET 8, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¸Ğ¼ĞµĞ½ Ğ´Ğ»Ñ Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹. Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ´Ğ²Ğ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° Ğ´Ğ¾Ğ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¸Ğ¼Ñ‘Ğ½:

### Ğ ĞµĞ¶Ğ¸Ğ¼ Legacy (ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹)

**Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚:** `{guid}.{domain}`

**Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ:**
```regex
^(?<guid>[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\.(?<domain>[-a-z0-9.]+)$
```

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**
- Ğ’ÑĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ğ¾ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ñƒ `{guid}.tunnel4.com` Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ÑÑ‚ Ğ¾Ğ´Ğ¸Ğ½ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ IP-Ğ°Ğ´Ñ€ĞµÑ
- ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: `203.0.113.42` (Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· `LegacyModeOptions.LegacyStaticIpAddress`)
- TTL: 300 ÑĞµĞºÑƒĞ½Ğ´
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¾Ğ¹

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**
```bash
dig A 2a3be342-60f3-48a9-a2c5-e7359e34959a.tunnel4.com @127.0.0.1
# ĞÑ‚Ğ²ĞµÑ‚: 203.0.113.42
```

### Ğ ĞµĞ¶Ğ¸Ğ¼ New (Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ)

**Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚:** `{address}-{proxyEntryId}.{domain}`

**Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾Ğµ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ:**
```regex
^(?<address>[a-z0-9-]{3,128})-(?<proxyEntryId>[a-z0-9][a-z0-9-]{0,31})\.(?<domain>[-a-z0-9.]+)$
```

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**
- Ğ”Ğ¾Ğ¼ĞµĞ½ Ñ€Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° Ñ‡Ğ°ÑÑ‚Ğ¸: Ğ°Ğ´Ñ€ĞµÑ (vanity name) Ğ¸ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾ĞºÑĞ¸-Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ…Ğ¾Ğ´Ğ°
- IP-Ğ°Ğ´Ñ€ĞµÑ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ `proxyEntryId` Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ `EntryIpAddressMapOptions.Map`
- TTL: 30 ÑĞµĞºÑƒĞ½Ğ´ (Ğ´Ğ»Ñ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹)
- ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ RabbitMQ Ğ¸ Redis Ğ´Ğ»Ñ real-time Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ°

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:**
```bash
dig A my-app-e1.tunnel4.com @127.0.0.1
# ĞÑ‚Ğ²ĞµÑ‚: 203.0.113.10 (IP Ğ´Ğ»Ñ entry "e1")

dig A test-service-e2.tunnel4.com @127.0.0.1
# ĞÑ‚Ğ²ĞµÑ‚: 203.0.113.11 (IP Ğ´Ğ»Ñ entry "e2")
```

### ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° ACME Challenge (TXT Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸)

Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ TXT-Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ ACME DNS-01 challenge (Let's Encrypt):

**Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚:** `_acme-challenge.{domain}`

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**
- Ğ—Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ğ² in-memory ÑĞ»Ğ¾Ğ²Ğ°Ñ€Ğµ (Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)
- TTL: 60 ÑĞµĞºÑƒĞ½Ğ´
- Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ° â†’ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ NXDOMAIN
- Ğ’ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼: CRUD API Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑĞ¼Ğ¸ Ñ‡ĞµÑ€ĞµĞ· HTTP

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**
```bash
dig TXT _acme-challenge.my-app-e1.tunnel4.com @127.0.0.1
# Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: NXDOMAIN (Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹)
```

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DNS Client (dig/resolver)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ UDP/TCP :53
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Tunnel2.DnsServer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          UdpDnsListener (Port 53/udp)                â”‚   â”‚
â”‚  â”‚          TcpDnsListener (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°, Ğ¿Ğ¾Ñ€Ñ‚ 53/tcp)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â”‚                                              â”‚
â”‚               â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           DnsRequestHandler                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ LegacyMatcher      â”‚  â”‚ NewMatcher          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ (GUID pattern)     â”‚  â”‚ (address-entryId)   â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ ACME Challenge Store (in-memory Dict)         â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚       Health Check Endpoint (:8080/healthz)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ğ‘ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  RabbitMQ    â”‚â”€â”€â”€â”€â–¶â”‚  Redis   â”‚â”€â”€â”€â”€â–¶â”‚ Entry IP Map   â”‚
  â”‚(SessionCreated)â”‚    â”‚ (cache)  â”‚     â”‚  (real-time)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â”€â”€â”€â”€â–¶ PostgreSQL (EF Core) - ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ, Ğ»Ğ¾Ğ³Ğ¸
```

## Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚

### Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

- .NET 8.0 SDK (Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸)
- Docker Ğ¸ Docker Compose (Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğµ)
- ĞŸÑ€Ğ°Ğ²Ğ° Ğ½Ğ° Ğ±Ğ¸Ğ½Ğ´Ğ¸Ğ½Ğ³ Ğº Ğ¿Ğ¾Ñ€Ñ‚Ñƒ 53 (Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ root/administrator Ğ¿Ñ€Ğ¸Ğ²Ğ¸Ğ»ĞµĞ³Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ CAP_NET_BIND_SERVICE)

### Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‡ĞµÑ€ĞµĞ· Docker Compose

```bash
# ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
git clone https://github.com/your-org/tunnel2-dns-server.git
cd tunnel2-dns-server

# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
docker-compose up -d

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸
docker-compose logs -f

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ health check
curl http://localhost:8080/healthz
```

### Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‡ĞµÑ€ĞµĞ· Docker (Ğ±ĞµĞ· compose)

```bash
# Ğ¡Ğ¾Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ·
docker build -t tunnel2-dns-server .

# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ñ host network (Linux)
docker run -d \
  --name tunnel2-dns-server \
  --network host \
  -e ASPNETCORE_ENVIRONMENT=Production \
  tunnel2-dns-server

# Ğ˜Ğ»Ğ¸ Ñ Ğ¿Ğ¾Ñ€Ñ‚Ğ°Ğ¼Ğ¸ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ CAP_NET_BIND_SERVICE)
docker run -d \
  --name tunnel2-dns-server \
  -p 53:53/udp \
  -p 53:53/tcp \
  -p 8080:8080/tcp \
  --cap-add=NET_BIND_SERVICE \
  tunnel2-dns-server
```

### Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ² Windows ĞºĞ°Ğº Service

```bash
# Ğ¡Ğ¾Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
dotnet publish src/Tunnel2.DnsServer/Tunnel2.DnsServer.csproj -c Release -o C:\Services\Tunnel2DnsServer

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ĞºĞ°Ğº Windows Service (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ PowerShell Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°)
sc.exe create Tunnel2DnsServer binPath="C:\Services\Tunnel2DnsServer\Tunnel2.DnsServer.exe" start=auto
sc.exe description Tunnel2DnsServer "Tunnel2 DNS Server - Authoritative DNS for xtunnel2"
sc.exe start Tunnel2DnsServer

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑ
sc.exe query Tunnel2DnsServer

# Ğ›Ğ¾Ğ³Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ² Event Viewer Ğ¸Ğ»Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Serilog Ğ´Ğ»Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ:** Ğ”Ğ»Ñ Windows Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ firewall Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ»Ñ UDP/TCP Ğ¿Ğ¾Ñ€Ñ‚Ğ° 53.

### Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸

```bash
# Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
dotnet restore

# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑĞµÑ€Ğ²ĞµÑ€ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ sudo/administrator Ğ´Ğ»Ñ Ğ¿Ğ¾Ñ€Ñ‚Ğ° 53)
sudo dotnet run --project src/Tunnel2.DnsServer/Tunnel2.DnsServer.csproj

# Ğ”Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ±ĞµĞ· sudo - Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ñ€Ñ‚ Ğ² appsettings.Development.json:
# "UdpPort": 5353

# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ñ‚ĞµÑÑ‚Ñ‹
dotnet test
```

## ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· `appsettings.json`:

```json
{
  "DnsServerOptions": {
    "ListenIpv4": "0.0.0.0",
    "UdpPort": 53,
    "TcpPort": 53,
    "AuthoritativeZones": ["tunnel4.com"],
    "ResponseTtlSeconds": {
      "LegacyA": 300,
      "NewA": 30,
      "Txt": 60,
      "Negative": 5
    }
  },
  "LegacyModeOptions": {
    "IsEnabled": true,
    "LegacyStaticIpAddress": "203.0.113.42"
  },
  "EntryIpAddressMapOptions": {
    "Map": {
      "e1": "203.0.113.10",
      "e2": "203.0.113.11"
    }
  }
}
```

### ĞŸĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

```bash
export DnsServerOptions__ListenIpv4="0.0.0.0"
export DnsServerOptions__UdpPort="53"
export LegacyModeOptions__IsEnabled="true"
export LegacyModeOptions__LegacyStaticIpAddress="203.0.113.42"
export EntryIpAddressMapOptions__Map__e1="203.0.113.10"
export EntryIpAddressMapOptions__Map__e2="203.0.113.11"
```

## Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ—Ğ°Ğ¿ÑƒÑĞº unit-Ñ‚ĞµÑÑ‚Ğ¾Ğ²

```bash
dotnet test --verbosity normal
```

### Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ dig

```bash
# Legacy format (GUID)
dig A 2a3be342-60f3-48a9-a2c5-e7359e34959a.tunnel4.com @127.0.0.1

# Expected response:
# ;; ANSWER SECTION:
# 2a3be342-60f3-48a9-a2c5-e7359e34959a.tunnel4.com. 300 IN A 203.0.113.42

# New format (address-entryId)
dig A my-app-e1.tunnel4.com @127.0.0.1

# Expected response:
# ;; ANSWER SECTION:
# my-app-e1.tunnel4.com. 30 IN A 203.0.113.10

dig A another-service-e2.tunnel4.com @127.0.0.1

# Expected response:
# ;; ANSWER SECTION:
# another-service-e2.tunnel4.com. 30 IN A 203.0.113.11

# TXT record (ACME challenge)
dig TXT _acme-challenge.test.tunnel4.com @127.0.0.1

# Expected response (Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ):
# ;; status: NXDOMAIN (Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹)

# Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ²Ğ½Ğµ authoritative zone
dig A example.com @127.0.0.1

# Expected response:
# ;; status: REFUSED

# ĞĞµÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ´Ğ¾Ğ¼ĞµĞ½ Ğ² authoritative zone
dig A nonexistent.tunnel4.com @127.0.0.1

# Expected response:
# ;; status: NXDOMAIN
```

## Ğ¡Ñ‚Ğ¸Ğ»ÑŒ ĞºĞ¾Ğ´Ğ° Ğ¸ Ğ½ĞµĞ¹Ğ¼Ğ¸Ğ½Ğ³

**Ğ’Ğ°Ğ¶Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾:** Ğ’ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ **ĞĞ• Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ ÑĞ¾ĞºÑ€Ğ°Ñ‰Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ¼ĞµĞ½Ğ°** Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…, Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ¸ ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ².

âŒ **ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾:**
```csharp
var cfg = new DnsServerOpts();
var svc = new DnsReqHandler();
string ip = opts.LegacyIp;
```

âœ… **ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾:**
```csharp
DnsServerOptions configuration = new DnsServerOptions();
DnsRequestHandler requestHandler = new DnsRequestHandler();
string ipAddress = options.LegacyStaticIpAddress;
```

Ğ­Ñ‚Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ·Ğ°ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¾ Ğ² `.editorconfig` Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ÑĞ±Ğ¾Ñ€ĞºĞµ.

## Ğ”Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ°

### Ğ­Ñ‚Ğ°Ğ¿ 1: âœ… ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾Ñ‚Ğ¸Ğ¿ (Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)
- [x] Legacy mode Ñ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ IP
- [x] Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ new mode Ñ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ¾Ğ¼ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°
- [x] UDP listener Ğ´Ğ»Ñ DNS Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
- [x] Ğ—Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ° TXT Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ (in-memory)
- [x] Health check endpoint
- [x] Unit Ñ‚ĞµÑÑ‚Ñ‹
- [x] Docker Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ¸ CI/CD

### Ğ­Ñ‚Ğ°Ğ¿ 2: ğŸ”„ Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ PostgreSQL Ğ¸ Entity Framework Core
- [ ] ĞœĞ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ´Ğ¾Ğ¼ĞµĞ½Ñ‹, Ğ·Ğ¾Ğ½Ñ‹, IP Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ¸)
- [ ] DbContext Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
- [ ] CRUD API Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑĞ¼Ğ¸
- [ ] Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ DNS-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ‘Ğ”

### Ğ­Ñ‚Ğ°Ğ¿ 3: ğŸ”„ RabbitMQ Ğ¸ Redis Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ
- [ ] ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ½Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ `SessionCreated` Ğ¸Ğ· RabbitMQ
- [ ] Real-time Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ğ° `proxyEntryId â†’ IP`
- [ ] Redis ĞºÑÑˆ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ¼Ğ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³Ñƒ
- [ ] Graceful failover Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Redis

### Ğ­Ñ‚Ğ°Ğ¿ 4: ğŸ”„ Vanity Names Ğ¸ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğµ Ğ´Ğ¾Ğ¼ĞµĞ½Ñ‹
- [ ] Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° `VanityNames` (Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° â†’ session GUID)
- [ ] ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ñ… Ğ´Ğ¾Ğ¼ĞµĞ½Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
- [ ] CNAME Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ custom domains
- [ ] Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ownership Ñ‡ĞµÑ€ĞµĞ· TXT Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸

### Ğ­Ñ‚Ğ°Ğ¿ 5: ğŸ”„ TCP Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ¸ DNSSEC
- [ ] ĞŸĞ¾Ğ»Ğ½Ğ¾Ñ†ĞµĞ½Ğ½Ñ‹Ğ¹ TCP listener (Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²)
- [ ] DNSSEC Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)

### Ğ­Ñ‚Ğ°Ğ¿ 6: ğŸ”„ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ observability
- [ ] Prometheus Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹, latency, cache hit rate)
- [ ] OpenTelemetry Ñ‚Ñ€ĞµĞ¹ÑĞ¸Ğ½Ğ³
- [ ] Structured logging (Serilog â†’ Elasticsearch)

## Ğ¡ÑÑ‹Ğ»ĞºĞ¸

- **ĞŸÑ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ°Ñ/Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ DNS (å‚è€ƒ):** [../xtunnel/dns-server](../xtunnel/dns-server)
- **Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ .NET 8:** https://learn.microsoft.com/en-us/dotnet/core/whats-new/dotnet-8
- **RFC 1035 (DNS Protocol):** https://www.rfc-editor.org/rfc/rfc1035
- **RFC 8555 (ACME):** https://www.rfc-editor.org/rfc/rfc8555

## Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ

MIT License - ÑĞ¼. Ñ„Ğ°Ğ¹Ğ» [LICENSE](LICENSE)

## ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸ Ğ²ĞºĞ»Ğ°Ğ´

Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ issue Ğ¸Ğ»Ğ¸ pull request Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ¸ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹.

---

**Ğ—Ğ°Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸:**
Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ UDP listener Ñ fire-and-forget Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ². Ğ’ production Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ:
- ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ rate limiting Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ¾Ñ‚ DNS amplification Ğ°Ñ‚Ğ°Ğº
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ connection pooling Ğ´Ğ»Ñ Redis Ğ¸ PostgreSQL
- ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ°Ğ»ĞµÑ€Ñ‚Ğ¸Ğ½Ğ³ Ğ´Ğ»Ñ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
